name: Get Hot News

on:
  schedule:
    - cron: "33 * * * *"

  workflow_dispatch:

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write
  pull-requests: write
  checks: write
  deployments: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        run: |
          if [ ! -f config/config.yaml ]; then
            echo "Error: Config missing"
            exit 1
          fi
          ls -la config/

      - name: Run crawler
        env:
          GITHUB_ACTIONS: true
        run: |
          python -m trendradar
          ls -la output/ || mkdir -p output
          ls -la output/

      - name: Debug output directory
        run: |
          echo "=== OUTPUT DIRECTORY CONTENTS ==="
          ls -la output/
          echo "=== CONFIG FILE ==="
          cat config/config.yaml
          echo "=== PYTHON VERSION ==="
          python --version
          echo "=== PIP LIST ==="
          pip list

      - name: Commit and push output
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add output/ || echo "No output files to add"
          git commit -m "Update trend data $(date +%Y-%m-%d_%H:%M:%S)" || echo "No changes to commit"
          git push origin ${{ github.ref_name }} || echo "Push failed, but workflow completed"
